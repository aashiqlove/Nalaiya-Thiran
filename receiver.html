(function(){
  let receiverID;
  const socket = io();

  function generateID() {
    return `${Math.trunc(Math.random()*999)}-${Math.trunc(Math.random()*999)}-${Math.trunc(Math.random()*999)}`;
  }

  document.getElementById("sender-start-con-btn").addEventListener("click", function(){
    let joinID = generateID();

    document.getElementById("join-id").innerHTML = `<b> Room Id </b><span>${joinID}</span>`;
    socket.emit("sender-join", {
      uid: joinID
    });
  });

  socket.on("init", function(uid) {
    receiverID = uid;
    document.querySelector(".join-screen").classList.remove("active");
    document.querySelector(".fs-screen").classList.add("active");
  });

  document.getElementById("file-input").addEventListener("change",function(e){
    const files = e.target.files;
    if(files.length === 0) return;

    // Clear existing file list
    const fileListDiv = document.getElementById("file-list");
    fileListDiv.innerHTML = "";

    // Iterate through each file and share it
    for(let i = 0; i < files.length; i++) {
      shareFile(files[i]);
    }
  });

  function shareFile(file){
    let reader = new FileReader();
    reader.onload = function(e){
      let buffer = new Uint8Array(reader.result);
      let el = document.createElement("div");
      el.classList.add("item");
      el.innerHTML = `
        <div class="progress">0%</div>
        <div class="filename">${file.name}</div>
      `;
      document.getElementById("file-list").appendChild(el);

      // Share the file
      shareFileChunked({
        filename: file.name,
        total_buffer_size: buffer.length,
        buffer_size: 1024
      }, buffer, el.querySelector(".progress"));
    }
    reader.readAsArrayBuffer(file);
  }

  function shareFileChunked(metadata, buffer, progress_node){
    socket.emit("file-meta", {
      uid: receiverID,
      metadata: metadata
    });

    let chunk;
    while(buffer.length > 0){
      chunk = buffer.slice(0, metadata.buffer_size);
      buffer = buffer.slice(metadata.buffer_size, buffer.length);

      socket.emit("file-raw", {
        uid: receiverID,
        buffer: chunk
      });
    }
    progress_node.innerHTML = "100%";
  }
})();
