package enam_data;

import org.json.JSONArray;
import org.json.JSONObject;
import java.io.FileWriter;
import java.io.OutputStream;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.*;



public class TRADE_DATA {
	public static void main(String[] args) {
        try {
        	Date currentDate = new Date();  
            currentDate.setTime(System.currentTimeMillis());  
            Date yesterdayDate = new Date(currentDate.getTime() - (1000 * 60 * 60 * 24));  
            SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");  
            String yesterdayDateString = dateFormat.format(yesterdayDate);
            URL url = new URL("https://enam.gov.in/web/Ajax_ctrl/trade_data_list");

            Map<String, String> parameters = new HashMap<>();
            parameters.put("language", "en");
            parameters.put("stateName", "-- All --");
            parameters.put("apmcName", "-- Select APMCs --");
            parameters.put("commodityName", "-- Select Commodity --");
            parameters.put("fromDate", yesterdayDateString);
            parameters.put("toDate", yesterdayDateString);

            StringBuilder postData = new StringBuilder();
            for (Map.Entry<String, String> param : parameters.entrySet()) {
                if (postData.length() != 0) {
                    postData.append('&');
                }
                postData.append(URLEncoder.encode(param.getKey(), "UTF-8"));
                postData.append('=');
                postData.append(URLEncoder.encode(param.getValue(), "UTF-8"));
            }

            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("POST");
            connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
            connection.setDoOutput(true);

            OutputStream outputStream = connection.getOutputStream();
            outputStream.write(postData.toString().getBytes("UTF-8"));
            outputStream.flush();

            int responseCode = connection.getResponseCode();
            StringBuilder response = new StringBuilder();
            if (responseCode == HttpURLConnection.HTTP_OK) {
                Scanner scanner = new Scanner(connection.getInputStream());
                while (scanner.hasNextLine()) {
                    response.append(scanner.nextLine());
                }
                scanner.close();
                System.out.println(response);
                JSONObject jsonResponse = new JSONObject(response.toString());
                JSONArray dataArray = jsonResponse.getJSONArray("data");
            
            
                String csvFilePath = "C:/Users/Aashik Ali/OneDrive/Desktop/New folder (3)/enam_trade/"+yesterdayDateString+"_data.csv";// Change this to your desired file path
                FileWriter writer = new FileWriter(csvFilePath);

                writer.write("id,state,apmc,commodity,min_price,modal_price,max_price,commodity_arrivals,commodity_traded,created_at,status,Units\n");

                for (int i = 0; i < dataArray.length(); i++) {
                    JSONObject data = dataArray.getJSONObject(i);
                    
                    if ( data.has("id") && data.has("state") && data.has("apmc") && data.has("commodity") && data.has("min_price") && data.has("modal_price") && data.has("max_price") && data.has("commodity_arrivals") && data.has("commodity_traded") && data.has("created_at") && data.has("status") && data.has("Commodity_Uom")) {
                   
                        String id = data.getString("id");
                        String state = data.getString("state");
                        String apmc = data.getString("apmc");
                        String commodity = data.getString("commodity");
                        String minPrice = data.getString("min_price");
                        String modalPrice = data.getString("modal_price");
                        String maxPrice = data.getString("max_price");
                        String commodityArrivals = data.getString("commodity_arrivals");
                        String commodityTraded = data.getString("commodity_traded");
                        String createdAt = data.getString("created_at");
                        String status = data.getString("status");
                        String commodityUom = data.getString("Commodity_Uom");


                        writer.write(id + "," + state + "," + apmc + "," + commodity + "," + minPrice + "," + modalPrice + "," + maxPrice + "," + commodityArrivals + "," + commodityTraded + "," + createdAt + "," + status + "," + commodityUom + "\n");
                    }
                }

                writer.close();
                System.out.println("Data saved to CSV file: " + csvFilePath);
            } else {
                System.out.println("Error: Received response code " + responseCode);
            }

            connection.disconnect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
